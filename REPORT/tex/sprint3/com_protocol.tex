\section{Communications Protocol}
\label{sec:com_protocol}
In order to facilitate communication between mobile clients and the match server a simple communications protocol was designed.
This protocol defines the set of legal messages (referred to as commands in this section) that may be exchanged between the client and the server.

The commands are encoded as \ac{JSON} and share a common format.
\ac{JSON} was chosen because libraries for serializing and deserializing \ac{JSON} are available for both Java and Python.

Every command has a \texttt{cmd} field indicating the type of command and a \texttt{data} field containing the data needed to process the command.
For some command types the \texttt{data} field may be \texttt{null} if no data is needed to process a command of that particular type.
All commands sent from a client to the server also contain an \texttt{id} field with a unique identifier for the user.

All commands are prefixed with two bytes in network byte order (big endian) indicating the length of the command.
Using this approach enables the receiving end to read a single command from the network buffer without accidentally reading into the beginning of the following command.
This is necessary because \ac{TCP}, which is the transport protocol, allows an endpoint to send multiple commands back-to-back without needing a reply in between.

\subsection{Commands}
In this section the different types of commands exchanged between the mobile clients and the server will be described.
Parameters are prefixed with a \texttt{\$} in the descriptions.

\subsubsection{Matchmaking Commands}
In order for a client to be matched against a suitable opponent it must first enter the matchmaking queue by sending the command shown in \autoref{tab:cmd_queue}.

\newenvironment{command}
{\bigskip\begin{minipage}{\textwidth}\hrule\begin{description}}
{\end{description}\hrule\end{minipage}\bigskip}

\begin{table}[!ht]
	\centering
	\begin{tabular}{| r | p{0.7\textwidth} |}
		\hline
		\textbf{Description} & Adds the client to the matchmaking queue. \\ \hline
		\textbf{Direction} & Client $\rightarrow$ Server. \\ \hline
		\textbf{Parameters} & \texttt{\$id} : The id of the client. \newline \texttt{\$route\_id} : The id of the route selected by the client. \\ \hline
		\textbf{Format} &
\begin{lstlisting}[language=Command]
{
	"cmd": "queue",
	"id": $id,
	"data": {
		"route_id": $route_id
	}
}
\end{lstlisting}
		\\ \hline
	\end{tabular}
	\caption{The \texttt{queue} Command}
	\label{tab:cmd_queue}
\end{table}

If the client wants to be removed from the matchmaking queue the command shown in \autoref{tab:cmd_cancel} must be sent.

\begin{table}[!ht]
	\centering
	\begin{tabular}{| r | p{0.7\textwidth} |}
		\hline
		\textbf{Description} & Removes the client from the matchmaking queue. \\ \hline
		\textbf{Direction} & Client $\rightarrow$ Server. \\ \hline
		\textbf{Parameters} & \texttt{\$id} : The id of the client. \\ \hline
		\textbf{Format} &
\begin{lstlisting}[language=Command]
{
	"cmd": "cancel",
	"id": $id,
	"data": null
}
\end{lstlisting}
		\\ \hline
	\end{tabular}
	\caption{The \texttt{cancel} Command}
	\label{tab:cmd_cancel}
\end{table}

When the server has found a suitable opponent it responds by sending the command shown in \autoref{tab:cmd_found} to both clients.

\begin{table}[!ht]
	\centering
	\begin{tabular}{| r | p{0.7\textwidth} |}
		\hline
		\textbf{Description} & Informs the client that an opponent has been found. \\ \hline
		\textbf{Direction} & Server $\rightarrow$ Client. \\ \hline
		\textbf{Parameters} & None. \\ \hline
		\textbf{Format} &
\begin{lstlisting}[language=Command]
{
	"cmd": "found",
	"data": null
}
\end{lstlisting}
		\\ \hline
	\end{tabular}
	\caption{The \texttt{found} Command}
	\label{tab:cmd_found}
\end{table}

Both clients must reply with the command shown in \autoref{tab:cmd_accept} in order for the match to begin.

\begin{table}[!ht]
	\centering
	\begin{tabular}{| r | p{0.7\textwidth} |}
		\hline
		\textbf{Description} & Accept the match. \\ \hline
		\textbf{Direction} & Client $\rightarrow$ Server. \\ \hline
		\textbf{Parameters} & \texttt{\$id} : The id of the client. \\ \hline
		\textbf{Format} &
\begin{lstlisting}[language=Command]
{
	"cmd": "accept",
	"id": $id,
	"data": null
}
\end{lstlisting}
		\\ \hline
	\end{tabular}
	\caption{The \texttt{accept} Command}
	\label{tab:cmd_accept}
\end{table}

If both clients have not accepted within 20 seconds the match will be cancelled and both clients will be removed from the matchmaking queue.
If both clients accept within the time limit the server will send the command shown in \autoref{tab:cmd_start} to both clients to inform them that the match will start in 10 seconds.

\begin{table}[!ht]
	\centering
	\begin{tabular}{| r | p{0.7\textwidth} |}
		\hline
		\textbf{Description} & Informs the client that the match starts in 10 seconds. \\ \hline
		\textbf{Direction} & Server $\rightarrow$ Client. \\ \hline
		\textbf{Parameters} & None. \\ \hline
		\textbf{Format} &
\begin{lstlisting}[language=Command]
{
	"cmd": "start",
	"data": null
}
\end{lstlisting}
		\\ \hline
	\end{tabular}
	\caption{The \texttt{start} Command}
	\label{tab:cmd_start}
\end{table}

\subsubsection{Match Progress Commands}
During a match both clients must continuously relay their positions to the server so that it can determine if they are both following the correct route and if one them has won the match.
\autoref{fig:match_flow} shows the basic flow of determining a winner (and loser) of a match.
The commands involved in this flow will be described presently.

\tikzstyle{decision} = [diamond, draw, fill=blue!20, minimum width=6em, minimum height=6em, text badly centered]
\tikzstyle{block} = [rectangle, draw, fill=blue!20, minimum width=5em, minimum height=3em, text centered, rounded corners]
\tikzstyle{line} = [draw, -latex']
\tikzstyle{cloud} = [ellipse, draw, fill=blue!20, minimum width=5em, text centered]
    
\begin{figure}[!ht]
	\centering
	\begin{tikzpicture}[node distance = 3cm, auto]
		\node [cloud] (start) {begin};
		\node [block, left of=start] (inprogress) {in progress};
		\node [decision, below of=inprogress] (finished) {done?};
		\node [block, right of=finished] (winner) {winner};
		\node [decision, left of=finished] (onroute) {on route?};
		\node [block, below of=onroute] (loser) {loser};
		\node [cloud, below of=winner] (end) {end};
		\path [line] (start) -- (inprogress);
		\path [line] (inprogress) -- node {send position} (finished);
		\path [line] (finished) -- node {yes} (winner);
		\path [line] (finished) -- node {no} (onroute);
		\path [line] (onroute) -- node {no} (loser);
		\path [line] (onroute) |- node {yes} (inprogress);
		\path [line] (winner) -- (end);
		\path [line] (loser) -- (end);
	\end{tikzpicture}
	\caption{Match Flow}
	\label{fig:match_flow}
\end{figure}

A client must continuously relay its current position to the server using the command shown in \autoref{tab:cmd_pos}. The server responds with the progress of the opponent as shown in \autoref{tab:cmd_pos_server}.

\begin{table}[!ht]
	\centering
	\begin{tabular}{| r | p{0.7\textwidth} |}
		\hline
		\textbf{Description} & Informs the server of the current position of the client. \\ \hline
		\textbf{Direction} & Client $\rightarrow$ Server. \\ \hline
		\textbf{Parameters} & \texttt{\$id} : The id of the client. \newline \texttt{\$lat} : Current latitude. \newline \texttt{\$lng} : Current longitude. \\ \hline
		\textbf{Format} &
\begin{lstlisting}[language=Command]
{
	"cmd": "position",
	"id": $id,
	"data": {
		"lat": $lat,
		"lng": $lng
	}
}
\end{lstlisting}
		\\ \hline
	\end{tabular}
	\caption{The \texttt{position} command (client)}
	\label{tab:cmd_pos}
\end{table}

\begin{table}[!ht]
	\centering
	\begin{tabular}{| r | p{0.7\textwidth} |}
		\hline
		\textbf{Description} & Informs the client of the progress of its opponent. \\ \hline
		\textbf{Direction} & Server $\rightarrow$ Client. \\ \hline
		\textbf{Parameters} & \texttt{\$completion} : Progress of opponent in percent. \\ \hline
		\textbf{Format} &
\begin{lstlisting}[language=Command]
{
	"cmd": "position",
	"data": {
		"completion": $completion
	}
}
\end{lstlisting}
		\\ \hline
	\end{tabular}
	\caption{The \texttt{position} command (server)}
	\label{tab:cmd_pos_server}
\end{table}

When a winner has been determined the server will send the command shown in \autoref{tab:cmd_winner} to both clients. A winner is determined when either of the participants enter a winner or loser state.

\begin{table}[!ht]
	\centering
	\begin{tabular}{| r | p{0.7\textwidth} |}
		\hline
		\textbf{Description} & Informs the client of the result of the match. \\ \hline
		\textbf{Direction} & Server $\rightarrow$ Client. \\ \hline
		\textbf{Parameters} & \texttt{\$winner\_id} : The id of the winner. \\ \hline
		\textbf{Format} &
\begin{lstlisting}[language=Command]
{
	"cmd": "winner",
	"data": {
		"result": $winner_id
	}
}
\end{lstlisting}
		\\ \hline
	\end{tabular}
	\caption{The \texttt{winner} command}
	\label{tab:cmd_winner}
\end{table}
